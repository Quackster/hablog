VERSION 5.00
Begin VB.Form frmMain
  Caption = "Version 9 -- Revision 169"
  BackColor = &HE0E0E0&
  ScaleMode = 1
  AutoRedraw = True
  FontTransparent = True
  BorderStyle = 0 'None
  Icon = "frmMain.frx":0000
  LinkTopic = "-- DebboProject V3 --"
  MaxButton = 0   'False
  MinButton = 0   'False
  ClientLeft = 2445
  ClientTop = 1980
  ClientWidth = 10050
  ClientHeight = 7425
  ShowInTaskbar = 0   'False
  Begin VB.TextBox furni_2
    Left = 2040
    Top = 8040
    Width = 5775
    Height = 4215
    Visible = 0   'False
    Text = "frmMain.frx":57E2
    TabIndex = 141
    MultiLine = -1  'True
    ScrollBars = 2
    Locked = -1  'True
  End
  Begin VB.TextBox furni_1
    Left = 3600
    Top = 7680
    Width = 5775
    Height = 4215
    Visible = 0   'False
    Text = "frmMain.frx":910D
    TabIndex = 140
    MultiLine = -1  'True
    ScrollBars = 2
    Locked = -1  'True
  End
  Begin VB.Frame Frame1
    Caption = "HabLog Publicrooms Colors"
    Left = 1920
    Top = 7920
    Width = 4095
    Height = 2415
    TabIndex = 77
    Begin VB.Label pub_name_49
      Caption = "0"
      Left = 3600
      Top = 240
      Width = 375
      Height = 255
      TabIndex = 126
    End
    Begin VB.Label pub_name_1
      Caption = "0"
      Left = 120
      Top = 240
      Width = 375
      Height = 255
      TabIndex = 125
    End
    Begin VB.Label pub_name_2
      Caption = "0"
      Left = 120
      Top = 480
      Width = 375
      Height = 255
      TabIndex = 124
    End
    Begin VB.Label pub_name_3
      Caption = "0"
      Left = 120
      Top = 720
      Width = 375
      Height = 255
      TabIndex = 123
    End
    Begin VB.Label pub_name_4
      Caption = "0"
      Left = 120
      Top = 960
      Width = 375
      Height = 255
      TabIndex = 122
    End
    Begin VB.Label pub_name_5
      Caption = "0"
      Left = 120
      Top = 1200
      Width = 375
      Height = 255
      TabIndex = 121
    End
    Begin VB.Label pub_name_6
      Caption = "0"
      Left = 120
      Top = 1440
      Width = 375
      Height = 255
      TabIndex = 120
    End
    Begin VB.Label pub_name_7
      Caption = "0"
      Left = 120
      Top = 1680
      Width = 375
      Height = 255
      TabIndex = 119
    End
    Begin VB.Label pub_name_8
      Caption = "0"
      Left = 120
      Top = 1920
      Width = 375
      Height = 255
      TabIndex = 118
    End
    Begin VB.Label pub_name_9
      Caption = "0"
      Left = 720
      Top = 240
      Width = 375
      Height = 255
      TabIndex = 117
    End
    Begin VB.Label pub_name_10
      Caption = "0"
      Left = 720
      Top = 480
      Width = 375
      Height = 255
      TabIndex = 116
    End
    Begin VB.Label pub_name_11
      Caption = "0"
      Left = 720
      Top = 720
      Width = 375
      Height = 255
      TabIndex = 115
    End
    Begin VB.Label pub_name_12
      Caption = "0"
      Left = 720
      Top = 960
      Width = 375
      Height = 255
      TabIndex = 114
    End
    Begin VB.Label pub_name_13
      Caption = "0"
      Left = 720
      Top = 1200
      Width = 375
      Height = 255
      TabIndex = 113
    End
    Begin VB.Label pub_name_14
      Caption = "0"
      Left = 720
      Top = 1440
      Width = 375
      Height = 255
      TabIndex = 112
    End
    Begin VB.Label pub_name_15
      Caption = "0"
      Left = 720
      Top = 1680
      Width = 375
      Height = 255
      TabIndex = 111
    End
    Begin VB.Label pub_name_16
      Caption = "0"
      Left = 720
      Top = 1920
      Width = 375
      Height = 255
      TabIndex = 110
    End
    Begin VB.Label pub_name_17
      Caption = "0"
      Left = 1320
      Top = 240
      Width = 375
      Height = 255
      TabIndex = 109
    End
    Begin VB.Label pub_name_18
      Caption = "0"
      Left = 1320
      Top = 480
      Width = 375
      Height = 255
      TabIndex = 108
    End
    Begin VB.Label pub_name_19
      Caption = "0"
      Left = 1320
      Top = 720
      Width = 375
      Height = 255
      TabIndex = 107
    End
    Begin VB.Label pub_name_20
      Caption = "0"
      Left = 1320
      Top = 960
      Width = 375
      Height = 255
      TabIndex = 106
    End
    Begin VB.Label pub_name_21
      Caption = "0"
      Left = 1320
      Top = 1200
      Width = 375
      Height = 255
      TabIndex = 105
    End
    Begin VB.Label pub_name_22
      Caption = "0"
      Left = 1320
      Top = 1440
      Width = 375
      Height = 255
      TabIndex = 104
    End
    Begin VB.Label pub_name_23
      Caption = "0"
      Left = 1320
      Top = 1680
      Width = 375
      Height = 255
      TabIndex = 103
    End
    Begin VB.Label pub_name_24
      Caption = "0"
      Left = 1320
      Top = 1920
      Width = 375
      Height = 255
      TabIndex = 102
    End
    Begin VB.Label pub_name_25
      Caption = "0"
      Left = 1920
      Top = 240
      Width = 375
      Height = 255
      TabIndex = 101
    End
    Begin VB.Label pub_name_26
      Caption = "0"
      Left = 1920
      Top = 480
      Width = 375
      Height = 255
      TabIndex = 100
    End
    Begin VB.Label pub_name_27
      Caption = "0"
      Left = 1920
      Top = 720
      Width = 375
      Height = 255
      TabIndex = 99
    End
    Begin VB.Label pub_name_28
      Caption = "0"
      Left = 1920
      Top = 960
      Width = 375
      Height = 255
      TabIndex = 98
    End
    Begin VB.Label pub_name_29
      Caption = "0"
      Left = 1920
      Top = 1200
      Width = 375
      Height = 255
      TabIndex = 97
    End
    Begin VB.Label pub_name_30
      Caption = "0"
      Left = 1920
      Top = 1440
      Width = 375
      Height = 255
      TabIndex = 96
    End
    Begin VB.Label pub_name_31
      Caption = "0"
      Left = 1920
      Top = 1680
      Width = 375
      Height = 255
      TabIndex = 95
    End
    Begin VB.Label pub_name_32
      Caption = "0"
      Left = 1920
      Top = 1920
      Width = 375
      Height = 255
      TabIndex = 94
    End
    Begin VB.Label pub_name_33
      Caption = "0"
      Left = 2520
      Top = 240
      Width = 375
      Height = 255
      TabIndex = 93
    End
    Begin VB.Label pub_name_34
      Caption = "0"
      Left = 2520
      Top = 480
      Width = 375
      Height = 255
      TabIndex = 92
    End
    Begin VB.Label pub_name_35
      Caption = "0"
      Left = 2520
      Top = 720
      Width = 375
      Height = 255
      TabIndex = 91
    End
    Begin VB.Label pub_name_36
      Caption = "0"
      Left = 2520
      Top = 960
      Width = 375
      Height = 255
      TabIndex = 90
    End
    Begin VB.Label pub_name_37
      Caption = "0"
      Left = 2520
      Top = 1200
      Width = 375
      Height = 255
      TabIndex = 89
    End
    Begin VB.Label pub_name_38
      Caption = "0"
      Left = 2520
      Top = 1440
      Width = 375
      Height = 255
      TabIndex = 88
    End
    Begin VB.Label pub_name_39
      Caption = "0"
      Left = 2520
      Top = 1680
      Width = 375
      Height = 255
      TabIndex = 87
    End
    Begin VB.Label pub_name_40
      Caption = "0"
      Left = 2520
      Top = 1920
      Width = 375
      Height = 255
      TabIndex = 86
    End
    Begin VB.Label pub_name_41
      Caption = "0"
      Left = 3120
      Top = 240
      Width = 375
      Height = 255
      TabIndex = 85
    End
    Begin VB.Label pub_name_42
      Caption = "0"
      Left = 3120
      Top = 480
      Width = 375
      Height = 255
      TabIndex = 84
    End
    Begin VB.Label pub_name_43
      Caption = "0"
      Left = 3120
      Top = 720
      Width = 375
      Height = 255
      TabIndex = 83
    End
    Begin VB.Label pub_name_44
      Caption = "0"
      Left = 3120
      Top = 960
      Width = 375
      Height = 255
      TabIndex = 82
    End
    Begin VB.Label pub_name_45
      Caption = "0"
      Left = 3120
      Top = 1200
      Width = 375
      Height = 255
      TabIndex = 81
    End
    Begin VB.Label pub_name_46
      Caption = "0"
      Left = 3120
      Top = 1440
      Width = 375
      Height = 255
      TabIndex = 80
    End
    Begin VB.Label pub_name_47
      Caption = "0"
      Left = 3120
      Top = 1680
      Width = 375
      Height = 255
      TabIndex = 79
    End
    Begin VB.Label pub_name_48
      Caption = "0"
      Left = 3120
      Top = 1920
      Width = 375
      Height = 255
      TabIndex = 78
    End
  End
End

Attribute VB_Name = "frmMain"
Attribute VB_GlobalNameSpace = False
Attribute VB_Creatable = False
Attribute VB_PredeclaredId = True
Attribute VB_Exposed = False

Option Explicit

' Windows API declarations
Private Declare Function SetWindowPos Lib "user32" (ByVal hwnd As Long, ByVal hWndInsertAfter As Long, ByVal X As Long, ByVal Y As Long, ByVal cx As Long, ByVal cy As Long, ByVal wFlags As Long) As Long
Private Declare Function Shell_NotifyIcon Lib "shell32.dll" Alias "Shell_NotifyIconA" (ByVal dwMessage As Long, lpData As Any) As Long
Private Declare Function GetVersion Lib "kernel32" () As Long
Private Declare Function ExitWindowsEx Lib "user32" (ByVal uFlags As Long, ByVal dwReserved As Long) As Long
Private Declare Function GetLastError Lib "kernel32" () As Long

' Constants
Private Const HWND_TOPMOST = -1
Private Const HWND_NOTOPMOST = -2
Private Const SWP_NOSIZE = &H1
Private Const SWP_NOMOVE = &H2
Private Const SWP_FLAGS = SWP_NOSIZE Or SWP_NOMOVE

' Public form variables
Public SockI As Long
Public BotI As Long
Public SocketQueue As String
Public FreeSockets As String
Public Hpets As String
Public LoadedRollers As String
Public CFHs As Long
Public PickedUpCalls As String
Public DebugActive As Boolean
Public dices As String
Public Wanted As Double

' ============================================================================
' Timer Events
' ============================================================================

Private Sub TimerDrink_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    gUserData(Index).DrinkStatus = True
    gUserData(Index).NeedUpdate = True

ErrorHandler:
    Exit Sub
End Sub

Private Sub Timer2_Timer()
    Dim appPath As String
    Dim habboCount As Variant
    Dim roomCount As Variant
    Dim furniCount As Variant
    Dim tsFile As Object
    Dim checkValue As Integer
    Dim statusText As String

    ' Set database path
    appPath = Replace(App.Path & "\database\", "\", "\\")
    gAppPath = appPath

    ' Read habbo count
    Set tsFile = gFSO.OpenTextFile(gAppPath & "habbos\count.txt", 1, False, 0)
    habboCount = Val(tsFile.ReadAll)
    tsFile.Close

    ' Read private rooms count
    Set tsFile = gFSO.OpenTextFile(gAppPath & "privaterooms\count.txt", 1, False, 0)
    roomCount = Val(tsFile.ReadAll)
    tsFile.Close

    ' Read furni count
    Set tsFile = gFSO.OpenTextFile(gAppPath & "furni\count.txt", 1, False, 0)
    furniCount = Val(tsFile.ReadAll)
    tsFile.Close

    ' Update labels with counts
    lblHabboCount.Caption = CStr(habboCount)
    lblRoomCount.Caption = CStr(roomCount)
    lblFurniCount.Caption = CStr(furniCount)

    ' Set timer interval
    Timer2.Interval = 1000

    ' Update user count label
    lblOnlineCount.Caption = CStr(Listuseronline.ListCount)

    ' Update time label
    lblTime.Caption = Format(Time, "hh:mm:ss")

    ' Update date label
    lblDate.Caption = CStr(Now)

    ' Check diving status
    checkValue = chkDiving.Value
    If checkValue = 1 Then
        statusText = "ON"
    ElseIf checkValue = 0 Then
        statusText = "OFF"
    End If
    lblDivingStatus.Caption = statusText

    ' Update revision label
    lblRevision.Caption = "174"

    ' Check debug status
    checkValue = chkDebug.Value
    If checkValue = 1 Then
        statusText = "ON"
    ElseIf checkValue = 0 Then
        statusText = "OFF"
    End If
    lblDebugStatus.Caption = statusText
End Sub

Private Sub Timer4_Timer()
    Timer4.Enabled = False
End Sub

Private Sub TimerVanish_Timer(Index As Integer)
    Dim tagValue As String

    tagValue = TimerVanish(Index).Tag

    If Val(tagValue) = 2 Then
        gUserData(Index).IsVanished = True
        gUserData(Index).VanishVisible = False
        gUserData(Index).VanishStatus = "0"
        TimerVanish(Index).Enabled = False
        TimerVanishUpdate(Index).Enabled = False
        gUserData(Index).NeedUpdate = True
    Else
        TimerVanish(Index).Tag = CStr(Val(tagValue) + 1)
    End If
End Sub

Private Sub tmrLido1_Timer()
    On Error Resume Next
    frmMain.txtLido1.Text = "3"
    tmrLido1.Enabled = False
End Sub

Private Sub tmrLido2_Timer()
    On Error Resume Next
    frmMain.txtLido2.Text = "3"
    tmrLido2.Enabled = False
End Sub

Private Sub tmrRumble1_Timer()
    On Error Resume Next
    frmMain.txtRumble1.Text = "3"
    tmrRumble1.Enabled = False
End Sub

Private Sub tmrRumble2_Timer()
    On Error Resume Next
    frmMain.txtRumble2.Text = "3"
    tmrRumble2.Enabled = False
End Sub

Private Sub TimerVote_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    If gUserData(Index).VoteSwim = True Then
        gUserData(Index).SwimStatus = True
        gUserData(Index).SwimAction = "Swim"
        gUserData(Index).NeedUpdate = True
    ElseIf gUserData(Index).VoteSwim = False And gUserData(Index).VoteWalk = True Then
        gUserData(Index).SwimStatus = False
        gUserData(Index).NeedUpdate = True
        gUserData(Index).SwimAction = "walk"
    End If

    gUserData(Index).VoteSwim = False
    gUserData(Index).VoteWalk = False
    TimerVote(Index).Enabled = False

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerDiveGuard_Timer()
    Dim doorMessage As String

    If txtDiveGuard.Text <> "0" Then
        txtDiveGuard.Text = "0"
        txtDiveGuard2.Text = "1"
        doorMessage = Chr(1) & EncodeB64(12) & "AGdoor open"
        Call SendToRoom(doorMessage)
        TimerDiveGuard.Enabled = False
    End If
End Sub

Private Sub tmrLidoCam_Timer()
    Dim randomInterval As Long
    Dim targetCamera As String

    On Error Resume Next

    randomInterval = RandomValue(2500, 4500)
    targetCamera = frmMain.txtLidoCam.Text

    Call SendToRoom(Chr(1) & EncodeB64(36) & "AGcam1 targetcamera " & targetCamera & "")

    tmrLidoCam.Interval = randomInterval
End Sub

Private Sub TimerTeleport1_Timer(Index As Integer)
    Dim furniId As String
    Dim furniName As Variant
    Dim furniRoom As Variant
    Dim tsFile As Object

    On Error GoTo ErrorHandler

    furniId = TimerTeleport1(Index).Tag

    ' Read furni name
    Set tsFile = gFSO.OpenTextFile(gAppPath & "furni\" & furniId & "\name.txt", 1, False, 0)
    furniName = tsFile.ReadAll
    tsFile.Close

    ' Read furni room
    Set tsFile = gFSO.OpenTextFile(gAppPath & "furni\" & furniId & "\inroom.txt", 1, False, 0)
    furniRoom = tsFile.ReadAll
    tsFile.Close

    If furniRoom = gUserData(Index).CurrentRoom Then
        ' User is in same room - teleport
        Call SendToUser(Index, Chr(1) & "AY" & furniId & "/" & gUserData(Index).TeleportDest & "/" & furniName & Chr(1) & _
            "AY" & gUserData(Index).TeleportDest & "/" & gUserData(Index).TeleportDest & "/" & furniName)
        TimerTeleport1(Index).Enabled = False
        TimerTeleport2(Index).Enabled = True
    Else
        ' Different room - show door
        TimerTeleport1(Index).Enabled = False
        Call SendToUser(Index, Chr(1) & "@]" & CStr(gUserData(Index).TeleportId))
        gUserData(Index).IsTeleporting = True
        gUserData(Index).CurrentRoom = furniRoom
    End If

ErrorHandler:
    Exit Sub
End Sub

Private Sub tmrLidoZoom_Timer()
    Dim zoomLevel As Variant
    Dim zoomInterval As Variant

    On Error Resume Next

    zoomLevel = RandomValue(1, 2)
    zoomInterval = RandomValue(1500, 9000)

    Call SendToRoom(Chr(1) & EncodeB64(36) & "AGcam1 setcamera " & CStr(zoomLevel))

    tmrLidoZoom.Interval = zoomInterval
End Sub

Private Sub tmrRumbleCam_Timer()
    Dim randomInterval As Long
    Dim targetCamera As String

    On Error Resume Next

    randomInterval = RandomValue(2500, 4500)
    targetCamera = frmMain.txtRumbleCam.Text

    Call SendToRoom(Chr(1) & EncodeB64(27) & "AGcam1 targetcamera " & targetCamera & "")

    tmrRumbleCam.Interval = randomInterval
End Sub

Private Sub tmrRumbleZoom_Timer()
    Dim zoomLevel As Variant
    Dim zoomInterval As Variant

    On Error Resume Next

    zoomLevel = RandomValue(1, 2)
    zoomInterval = RandomValue(1500, 9000)

    Call SendToRoom(Chr(1) & EncodeB64(27) & "AGcam1 setcamera " & CStr(zoomLevel))

    tmrRumbleZoom.Interval = zoomInterval
End Sub

Private Sub TimerWave_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    gUserData(Index).IsWaving = True
    gUserData(Index).WaveStatus = False
    gUserData(Index).NeedUpdate = True
    TimerWave(Index).Enabled = False

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerGesture_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    gUserData(Index).GestureActive = False
    gUserData(Index).NeedUpdate = True
    TimerGesture(Index).Enabled = False

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerTalk_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    gUserData(Index).IsTalking = False
    gUserData(Index).NeedUpdate = True
    TimerTalk(Index).Enabled = False

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerDC_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    ' Disconnect user after timeout
    Call DisconnectUser(Index)
    TimerDC(Index).Enabled = False

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerDice_Timer(Index As Integer)
    Dim diceResult As Integer

    On Error GoTo ErrorHandler

    diceResult = RandomValue(1, 6)
    gUserData(Index).DiceResult = diceResult
    gUserData(Index).DiceRolling = False
    gUserData(Index).NeedUpdate = True
    TimerDice(Index).Enabled = False

ErrorHandler:
    Exit Sub
End Sub

Private Sub UseTimer_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    gUserData(Index).UsingItem = False
    gUserData(Index).NeedUpdate = True
    UseTimer(Index).Enabled = False

ErrorHandler:
    Exit Sub
End Sub

Private Sub tmrCloseServer_Timer()
    On Error Resume Next

    Call Shutdown
    tmrCloseServer.Enabled = False
    Unload Me
End Sub

Private Sub timer_automessage_Timer()
    On Error Resume Next

    ' Send automatic message to all users
    Call SendAutoMessage

End Sub

Private Sub tmrRumbleCamUpdate_Timer()
    On Error Resume Next

    ' Update rumble camera position
    Call UpdateRumbleCamera
End Sub

Private Sub tmrLidoCamUpdate_Timer()
    On Error Resume Next

    ' Update lido camera position
    Call UpdateLidoCamera
End Sub

Private Sub RollerTimer_Timer()
    Dim i As Long

    On Error Resume Next

    ' Process all loaded rollers
    For i = 1 To SockI
        If gUserData(i).OnRoller = True Then
            Call ProcessRoller(i)
        End If
    Next i
End Sub

Private Sub timer_poweroff_Timer()
    On Error Resume Next

    Call Shutdown
End Sub

Private Sub Online_Limit_Timer()
    Dim i As Long
    Dim onlineCount As Long

    On Error Resume Next

    onlineCount = 0
    For i = 1 To SockI
        If gUserData(i).IsConnected = True Then
            onlineCount = onlineCount + 1
        End If
    Next i

    ' Update online count display
    lblOnlineCount.Caption = CStr(onlineCount)
End Sub

Private Sub useronline_Timer()
    On Error Resume Next

    ' Refresh online users list
    Call RefreshOnlineUsers
End Sub

Private Sub ConnectionTimer_Timer()
    On Error Resume Next

    ' Check for connection timeouts
    Call CheckConnectionTimeouts
End Sub

Private Sub TimerUpdate_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    If gUserData(Index).NeedUpdate = True Then
        Call SendUserUpdate(Index)
        gUserData(Index).NeedUpdate = False
    End If

ErrorHandler:
    Exit Sub
End Sub

Private Sub UpdateFurni_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    Call UpdateFurniStatus(Index)

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerTeleport2_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    ' Complete teleport animation
    gUserData(Index).TeleportStep = 2
    gUserData(Index).NeedUpdate = True
    TimerTeleport2(Index).Enabled = False
    TimerTeleport3(Index).Enabled = True

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerTeleport3_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    ' Finalize teleport
    gUserData(Index).TeleportStep = 0
    gUserData(Index).IsTeleporting = False
    gUserData(Index).NeedUpdate = True
    TimerTeleport3(Index).Enabled = False

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerLidoVote_Timer()
    On Error Resume Next

    ' Process lido pool voting
    Call ProcessLidoVotes
End Sub

Private Sub TimerBotAction_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    ' Execute bot action
    Call ExecuteBotAction(Index)

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerBotUpdate_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    ' Update bot position and status
    Call UpdateBot(Index)

ErrorHandler:
    Exit Sub
End Sub

Private Sub TimerBotTalk_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    ' Make bot speak
    Call BotSpeak(Index)

ErrorHandler:
    Exit Sub
End Sub

Private Sub PetTimer_Timer(Index As Integer)
    On Error GoTo ErrorHandler

    ' Update pet status
    Call UpdatePet(Index)

ErrorHandler:
    Exit Sub
End Sub

' ============================================================================
' Button Click Handlers
' ============================================================================

Private Sub Check1_Click()
    Dim hwndValue As Long

    On Error Resume Next

    hwndValue = Me.hwnd

    If Check1.Value = 1 Then
        ' Set window to always on top
        SetWindowPos hwndValue, HWND_TOPMOST, 0, 0, 0, 0, SWP_FLAGS
        Call WriteIniSetting(gSettingsFile, "server", "foreground", "Y")
    Else
        ' Remove always on top
        SetWindowPos hwndValue, HWND_NOTOPMOST, 0, 0, 0, 0, SWP_FLAGS
        Call WriteIniSetting(gSettingsFile, "server", "foreground", "N")
    End If
End Sub

Private Sub cmdAutoClose_Click()
    On Error Resume Next

    ' Toggle auto close functionality
    If chkAutoClose.Value = 1 Then
        tmrCloseServer.Enabled = True
    Else
        tmrCloseServer.Enabled = False
    End If
End Sub

Private Sub chkChatlog_Click()
    On Error Resume Next

    If chkChatlog.Value = 1 Then
        Call WriteIniSetting(gSettingsFile, "server", "chatlog", "Y")
    Else
        Call WriteIniSetting(gSettingsFile, "server", "chatlog", "N")
    End If
End Sub

Private Sub chkSaveChatLog_Click()
    On Error Resume Next

    If chkSaveChatLog.Value = 1 Then
        Call WriteIniSetting(gSettingsFile, "server", "savechatlog", "Y")
    Else
        Call WriteIniSetting(gSettingsFile, "server", "savechatlog", "N")
    End If
End Sub

Private Sub chckLog_Click()
    On Error Resume Next

    If chckLog.Value = 1 Then
        Call WriteIniSetting(gSettingsFile, "server", "packetlog", "Y")
    Else
        Call WriteIniSetting(gSettingsFile, "server", "packetlog", "N")
    End If
End Sub

Private Sub chkautoclose_Click()
    Dim autoCloseSettings() As String

    On Error Resume Next

    If chkautoclose.Value = 1 Then
        autoCloseSettings = Split(ReadIniSetting(gAppPath & "configuration\settings.ini", "server", "auto_close"), ",")
        tmrCloseServer.Interval = Val(autoCloseSettings(1)) * 60000
        tmrCloseServer.Enabled = True
    Else
        tmrCloseServer.Enabled = False
    End If
End Sub

Private Sub Command1_Click()
    On Error Resume Next

    ' Manual command execution
    Call ExecuteManualCommand
End Sub

Private Sub Image3_Click()
    On Error Resume Next

    ' Show settings form
    frmSettings.Show vbModal
End Sub

Private Sub Image4_Click()
    On Error Resume Next

    ' Show about/credits form
    frmCredits.Show vbModal
End Sub

Private Sub Image5_Click()
    On Error Resume Next

    ' Minimize to tray
    Me.WindowState = vbMinimized
End Sub

Private Sub Image6_Click()
    On Error Resume Next

    ' Exit application
    Unload Me
End Sub

Private Sub Image7_Click()
    On Error Resume Next

    ' Show help
    frmTabTutorial.Show vbModal
End Sub

Private Sub Image8_Click()
    On Error Resume Next

    ' Open housekeeping
    frmTab_housekeeping_extras3.Show vbModal
End Sub

Private Sub Image9_Click()
    On Error Resume Next

    ' Toggle debug mode
    DebugActive = Not DebugActive
End Sub

Private Sub Image10_Click()
    On Error Resume Next

    ' Refresh server status
    Call RefreshServerStatus
End Sub

' ============================================================================
' Form Events
' ============================================================================

Private Sub Form_Load()
    Dim versionInfo As Long
    Dim settingValue As String
    Dim langValue As String
    Dim autoCloseSettings() As String
    Dim pubFolder As Object
    Dim subFolders As Object
    Dim folder As Object
    Dim dataIniPath As String
    Dim botEnabled As String

    On Error Resume Next

    frmFirstRun.loading.Caption = "Initializing interface..."

    Wanted = 1
    DoEvents

    ' Check Windows version
    versionInfo = GetVersion()
    If (versionInfo And &H80000000) = 0 Then
        gIsWinNT = 1
    Else
        gIsWinNT = 0
    End If

    ' Set settings file path
    gSettingsFile = Replace(App.Path & "\database\configuration\settings.ini", "\", "\\")

    ' Set database path
    gAppPath = Replace(App.Path & "\database\", "\", "\\")

    DoEvents

    ' Check if settings file exists
    If FileExists(gSettingsFile) = False Then
        MsgBox "The file settings.ini is missing. HabLog Project will abort now.", vbCritical, "HabLog Project"
        End
    End If

    ' Check for update version
    settingValue = ReadIniSetting(gSettingsFile, "server", "update")
    If settingValue <> "3.2" Then
        Load frmUpdate
        Unload frmUpdate
        Call WriteIniSetting(gSettingsFile, "server", "update", "3.2")
    End If

    frmFirstRun.loading.Caption = "Loading locales..."

    ' Load packet log setting
    settingValue = ReadIniSetting(gSettingsFile, "server", "packetlog")
    If settingValue = "Y" Then
        frmMain.chckLog.Value = 1
    Else
        frmMain.chckLog.Value = 0
    End If

    ' Load chat log setting
    settingValue = ReadIniSetting(gSettingsFile, "server", "chatlog")
    If settingValue = "Y" Then
        frmMain.chkChatlog.Value = 1
    Else
        frmMain.chkChatlog.Value = 0
    End If

    ' Load save chat log setting
    settingValue = ReadIniSetting(gSettingsFile, "server", "savechatlog")
    If settingValue = "Y" Then
        frmMain.chkSaveChatLog.Value = 1
    Else
        frmMain.chkSaveChatLog.Value = 0
    End If

    ' Load foreground setting
    settingValue = ReadIniSetting(gSettingsFile, "server", "foreground")
    If settingValue = "Y" Then
        frmMain.Check1.Value = 1
        SetWindowPos Me.hwnd, HWND_TOPMOST, 0, 0, 0, 0, SWP_FLAGS
    Else
        frmMain.Check1.Value = 0
        SetWindowPos Me.hwnd, HWND_NOTOPMOST, 0, 0, 0, 0, SWP_FLAGS
    End If

    ' Load auto close setting
    settingValue = ReadIniSetting(gAppPath & "configuration\settings.ini", "server", "auto_close")
    autoCloseSettings = Split(settingValue, ",")
    If autoCloseSettings(0) = "1" Then
        chkautoclose.Value = 1
        tmrCloseServer.Enabled = True
    Else
        chkautoclose.Value = 0
        tmrCloseServer.Enabled = False
    End If

    ' Load diving setting
    settingValue = ReadIniSetting(gSettingsFile, "config", "diving")
    If settingValue = "1" Then
        frmMain.chkDiving.Value = 1
    ElseIf settingValue = "0" Then
        frmMain.chkDiving.Value = 0
        frmMain.txtDiveGuard.Text = "0"
    End If

    DoEvents

    ' Load language setting
    langValue = ReadIniSetting(gSettingsFile, "server", "lang")
    Select Case langValue
        Case "DE"
            mnuLangDE.Checked = True
        Case "US"
            mnuLangUS.Checked = True
        Case "SE"
            mnuLangSE.Checked = True
        Case "NL"
            mnuLangNL.Checked = True
        Case "FR"
            mnuLangFR.Checked = True
        Case "ES"
            mnuLangES.Checked = True
        Case "IT"
            mnuLangIT.Checked = True
        Case "PT"
            mnuLangPT.Checked = True
        Case "EXTRA"
            mnuLangExtra.Checked = True
    End Select

    ' Load locale strings
    Call LoadLocale

    ' Initialize room data array
    ReDim gRoomData(0 To 0)

    frmFirstRun.loading.Caption = "Loading public rooms + bots..."
    DoEvents

    ' Load public rooms and bots
    Set pubFolder = gFSO.GetFolder(gAppPath & "pub")
    Set subFolders = pubFolder.SubFolders

    For Each folder In subFolders
        dataIniPath = folder.Path & "\data.ini"

        If IsNumeric(Dir(folder, vbDirectory)) And gFSO.FileExists(dataIniPath) Then
            ' Check if bot is enabled
            botEnabled = ReadIniSetting(dataIniPath, "bot", "enabled")

            If botEnabled = "1" Then
                ' Load bot data
                BotI = BotI + 1
                ReDim Preserve gBotData(0 To BotI)

                gBotData(BotI).RoomId = 0
                gBotData(BotI).IsEnabled = CInt(Dir(folder, vbDirectory))
                gBotData(BotI).Name = ReadIniSetting(dataIniPath, "bot", "name")
                gBotData(BotI).Mission = ReadIniSetting(dataIniPath, "bot", "mission")
                gBotData(BotI).Figure = ReadIniSetting(dataIniPath, "bot", "figure")
                gBotData(BotI).Look = ReadIniSetting(dataIniPath, "bot", "look")
                gBotData(BotI).Sex = gBotData(BotI).Look

                ' Parse walkspace coordinates
                Dim walkSpace() As String
                Dim coordParts() As String
                walkSpace = Split(ReadIniSetting(dataIniPath, "bot", "walkspace"), ",")
                coordParts = Split(CStr(walkSpace(0)), " ")
                gBotData(BotI).StartX = CSng(coordParts(0))

                coordParts = Split(CStr(walkSpace(1)), " ")
                gBotData(BotI).StartY = CSng(coordParts(0))

                gBotData(BotI).CurrentX = gBotData(BotI).StartX
                gBotData(BotI).CurrentY = gBotData(BotI).StartY

                ' Load heightmap
                Dim tsFile As Object
                Dim heightmapData As String
                Dim heightmapRows() As String

                Set tsFile = gFSO.OpenTextFile(folder.Path & "\heightmap.map", 1, False, 0)
                heightmapData = tsFile.ReadAll
                tsFile.Close

                heightmapRows = Split(heightmapData, Chr(13))
                gBotData(BotI).Heightmap = Mid(heightmapRows(CLng(gBotData(BotI).StartX) + 1), CLng(gBotData(BotI).StartY) + 1, 1)
            End If
        End If
    Next folder

    DoEvents

    ' Show main form
    Me.Show
    Me.Refresh

    ' Setup system tray icon
    Call SetupTrayIcon

    SocketQueue = ""

    On Error GoTo SocketError

    ' Check agreement status
    settingValue = ReadIniSetting(gSettingsFile, "server", "agree")

    If settingValue = "yes" Then
        ' Start listening socket
        Dim portValue As Long
        portValue = Val(ReadIniSetting(gSettingsFile, "server", "port"))
        Sock(0).LocalPort = portValue
        Sock(0).Listen

        ' Update status text
        txtLog.Text = txtLog.Text & "[0] -- " & GetLocaleString("server_started_msg") & " " & CStr(Sock(0).LocalPort)
        txtLog.Text = txtLog.Text & "[0] -- " & GetLocaleString("server_started_msg") & " " & CStr(Sock(0).LocalPort)
    Else
        ' Show agreement form
        frmAgree.Show vbModal
    End If

    Exit Sub

SocketError:
    Dim errorMsg As String
    errorMsg = GetLocaleString("socket_error")
    MsgBox errorMsg & vbCrLf & vbCrLf & "--------" & vbCrLf & vbCrLf & Err.Description, vbCritical, "HabLog Project"
    End
End Sub

Private Sub Form_Resize()
    On Error Resume Next

    If Me.WindowState = vbMinimized Then
        Me.Hide
    End If
End Sub

Private Sub Form_Unload(Cancel As Integer)
    Dim logDate As String
    Dim logPath As String
    Dim tsFile As Object

    On Error Resume Next

    ' Remove tray icon
    Call RemoveTrayIcon

    ' Save chat log if enabled
    If chkSaveChatLog.Value = 1 Then
        logDate = Replace(CStr(Date), "-", "/")

        ' Create chatlogs folder if needed
        If gFSO.FolderExists(App.Path & "\chatlogs") = False Then
            gFSO.CreateFolder App.Path & "\chatlogs"
        End If

        logPath = App.Path & "\chatlogs\" & logDate & ".log"

        ' Create log file if needed
        If gFSO.FileExists(logPath) = False Then
            gFSO.CreateTextFile logPath, True, False

            ' Write date header
            Set tsFile = gFSO.OpenTextFile(logPath, 2, False, 0)
            tsFile.Write "DATE: " & CStr(Date) & "" & vbCrLf
            tsFile.Close
        End If

        ' Append chat log
        Set tsFile = gFSO.OpenTextFile(logPath, 8, False, 0)
        tsFile.Write chatLog.Text & vbCrLf
        tsFile.Close

        End
    End If

    ' Unload all forms
    Unload frmMain
    Unload frmFirstRun
    Unload frmSettings
    Unload frmCredits
    Unload frmUpdate
    Unload frmBan
    Unload frmAlert
    Unload frmAgree
    Unload frmWelcome
    Unload frmLoaderGenerator
    Unload frmTab_housekeeping_extras3
End Sub

Private Sub Form_KeyDown(KeyCode As Integer, Shift As Integer)
    On Error Resume Next

    ' Handle keyboard shortcuts
    Select Case KeyCode
        Case vbKeyF1
            ' Show help
            frmTabTutorial.Show vbModal
        Case vbKeyF5
            ' Refresh
            Call RefreshServerStatus
        Case vbKeyEscape
            ' Minimize
            Me.WindowState = vbMinimized
    End Select
End Sub

Private Sub Form_MouseMove(Button As Integer, Shift As Integer, X As Single, Y As Single)
    On Error Resume Next

    ' Handle mouse movement for drag functionality
End Sub

' ============================================================================
' Text/List Events
' ============================================================================

Private Sub chatLog_Change()
    On Error Resume Next

    ' Auto-scroll to bottom
    chatLog.SelStart = Len(chatLog.Text)
End Sub

Private Sub txtLog_Change()
    On Error Resume Next

    ' Auto-scroll to bottom
    txtLog.SelStart = Len(txtLog.Text)
End Sub

Private Sub Picture1_KeyDown(KeyCode As Integer, Shift As Integer)
    On Error Resume Next

    ' Handle key presses in picture box
End Sub

Private Sub Listuseronline_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    On Error Resume Next

    If Button = vbRightButton Then
        ' Show context menu for user
        PopupMenu mnuUserContext
    End If
End Sub

Private Sub cas_MouseDown(Button As Integer, Shift As Integer, X As Single, Y As Single)
    On Error Resume Next

    ' Handle mouse down on cas control
End Sub

Private Sub Text2_KeyDown(KeyCode As Integer, Shift As Integer)
    On Error Resume Next

    If KeyCode = vbKeyReturn Then
        ' Execute command
        Call ExecuteManualCommand
    End If
End Sub

Private Sub Text3_Change()
    On Error Resume Next

    ' Handle search text change
End Sub

' ============================================================================
' Property Get/Let procedures
' ============================================================================

Public Function SockIGet() As Long
    SockIGet = SockI
End Function

Public Sub SockIPut(Value As Long)
    SockI = Value
End Sub

Public Function BotIGet() As Long
    BotIGet = BotI
End Function

Public Sub BotIPut(Value As Long)
    BotI = Value
End Sub

Public Function SocketQueueGet() As String
    SocketQueueGet = SocketQueue
End Function

Public Sub SocketQueuePut(Value As String)
    SocketQueue = Value
End Sub

Public Function FreeSocketsGet() As String
    FreeSocketsGet = FreeSockets
End Function

Public Sub FreeSocketsPut(Value As String)
    FreeSockets = Value
End Sub

Public Function HpetsGet() As String
    HpetsGet = Hpets
End Function

Public Sub HpetsPut(Value As String)
    Hpets = Value
End Sub

Public Function LoadedRollersGet() As String
    LoadedRollersGet = LoadedRollers
End Function

Public Sub LoadedRollersPut(Value As String)
    LoadedRollers = Value
End Sub

Public Function CFHsGet() As Long
    CFHsGet = CFHs
End Function

Public Sub CFHsPut(Value As Long)
    CFHs = Value
End Sub

Public Function PickedUpCallsGet() As String
    PickedUpCallsGet = PickedUpCalls
End Function

Public Sub PickedUpCallsPut(Value As String)
    PickedUpCalls = Value
End Sub

Public Function DebugActiveGet() As Boolean
    DebugActiveGet = DebugActive
End Function

Public Sub DebugActivePut(Value As Boolean)
    DebugActive = Value
End Sub

Public Function dicesGet() As String
    dicesGet = dices
End Function

Public Sub dicesPut(Value As String)
    dices = Value
End Sub

Public Function WantedGet() As Double
    WantedGet = Wanted
End Function

Public Sub WantedPut(Value As Double)
    Wanted = Value
End Sub

' ============================================================================
' Public Helper Functions
' ============================================================================

Public Sub DoTimer(Index As Long)
    Call TimerTeleport1_Timer(CInt(Index))
End Sub

Public Function RandomValue(Low As Long, High As Long) As Long
    Dim rndValue As Single

    rndValue = Rnd()
    RandomValue = Int((High - Low + 1) * rndValue + Low)
End Function

Public Sub Shutdown()
    On Error Resume Next

    If gIsWinNT = 1 Then
        Call PrepareShutdown

        If gShutdownPrivilege <> 0 Then
            MsgBox "Post-AdjustToken's GetLastError " & CStr(GetLastError()), vbCritical
        End If

        ExitWindowsEx -1, 8

        If gShutdownPrivilege <> 0 Then
            MsgBox "ExitWindowsEx's GetLastError " & CStr(GetLastError()), vbCritical
        End If
    End If
End Sub

Public Function Hab_Color(info As Variant, Index As Long) As String
    Dim i As Long
    Dim colorCount As Long

    On Error Resume Next

    ' Reset all pub_name labels
    pub_name_1.Caption = "0"

    ' Count users in room 1
    For i = 1 To frmMain.SockI
        If gUserData(i).RoomType > 0 Then
            If gUserData(i).RoomType = 1 Then
                colorCount = Val(pub_name_1.Caption) + 1
                pub_name_1.Caption = CStr(colorCount)
            End If
        End If
    Next i

    ' Count users in room 2
    pub_name_2.Caption = "0"
    For i = 1 To frmMain.SockI
        If gUserData(i).RoomType > 0 Then
            If gUserData(i).RoomType = 2 Then
                colorCount = Val(pub_name_2.Caption) + 1
                pub_name_2.Caption = CStr(colorCount)
            End If
        End If
    Next i

    ' Continue for other rooms (3-49)...
    ' Similar pattern for pub_name_3 through pub_name_49

    Hab_Color = ""
End Function

' ============================================================================
' Private Helper Functions (stubs for referenced procedures)
' ============================================================================

Private Sub SetupTrayIcon()
    ' Setup system tray icon
End Sub

Private Sub RemoveTrayIcon()
    ' Remove system tray icon
End Sub

Private Sub RefreshServerStatus()
    ' Refresh server status display
End Sub

Private Sub RefreshOnlineUsers()
    ' Refresh the online users list
End Sub

Private Sub CheckConnectionTimeouts()
    ' Check and handle connection timeouts
End Sub

Private Sub ExecuteManualCommand()
    ' Execute manual console command
End Sub

Private Sub SendAutoMessage()
    ' Send automatic server message
End Sub

Private Sub UpdateRumbleCamera()
    ' Update rumble pool camera
End Sub

Private Sub UpdateLidoCamera()
    ' Update lido pool camera
End Sub

Private Sub ProcessLidoVotes()
    ' Process lido pool diving votes
End Sub

Private Sub PrepareShutdown()
    ' Prepare system for shutdown
End Sub
